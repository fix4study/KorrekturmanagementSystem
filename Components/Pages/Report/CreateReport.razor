@page "/meldungen/neu"
@using System.Text
@using Korrekturmanagementsystem.Components.Shared
@using Korrekturmanagementsystem.Dtos
@using Korrekturmanagementsystem.Dtos.Report
@using Korrekturmanagementsystem.Models
@using Korrekturmanagementsystem.Services.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@inject IReportService ReportService
@inject NavigationManager Navigation
@rendermode InteractiveServer

@if (_optionsDto != null)
{
    <h3 class="mb-4">Meldung hinzufügen</h3>

    <ReportForm Model="@_viewModel"
                Options="@_optionsDto"
                IsEdit="false"
                ShowMessage="@_message"
                OnValidSubmit="HandleValidSubmit"
                SelectedTags="@_selectedTags"
                SelectedTagsChanged="HandleSelectedTagsChanged" />

    <FileUploadPanel OnFilesChanged="files => _selectedFiles = files.ToList()" />
}

@code {
    public EditReportModel _viewModel { get; set; } = new();
    public ReportFormOptionsDto _optionsDto { get; set; } = default!;
    private List<IBrowserFile> _selectedFiles = new();
    private List<TagDto> _selectedTags = new();
    private string _message = "";

    protected override async Task OnInitializedAsync()
    {
        var options = await ReportService.GetFormOptionsAsync();
    }

    private async Task HandleValidSubmit()
    {
        var result = await ReportService.AddReportAsync(_viewModel, _selectedTags, _selectedFiles);

        _message = result.Message ?? "Unbekannter Fehler.";

        await Task.Delay(1500);
        Navigation.NavigateTo("/meldungen");
    }

    private Task HandleSelectedTagsChanged(List<TagDto> tags)
    {
        _selectedTags = tags;
        return Task.CompletedTask;
    }
}
